import sys, os
from stop_words import get_stop_words

stop_words = get_stop_words('english')
yearList = [1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011,
            2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019]
# monthList = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'] #EXPLOIT, NVD, RAPID7
monthList = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']  # snyk
table = "Snyk"

script_dir = os.path.dirname(__file__)
for year in yearList:
    print("Writing entries for year " + str(year) + "...")
    for month in monthList:
        words = [[], []]  # structure is: [ [999, 998, ...], ["test", "test2", ...] ]
        rel_path = table + "/" + str(year) + "." + str(month) + ".csv"
        file = os.path.join(script_dir, rel_path)
        reader = open(file, encoding='utf8').read().splitlines()

        for line in reader:
            if line == "":  # this only happens with malformed line breaks
                continue
            lineIsSafe = True
            for x in stop_words:
                lineBeforeComma, lineAfterComma = line.lower().split(",", 1)
                lineAfterComma = lineAfterComma.strip('.,:;!()[]\\/\#%&@"\'-_="''')
                if (len(lineAfterComma) < 3 or lineAfterComma.isnumeric() or any(
                        [x == lineAfterComma]) or not lineAfterComma.islower()):
                    lineIsSafe = False
                    break
            if (lineIsSafe):
                if (lineAfterComma not in words[1]):
                    words[0].append(lineBeforeComma)
                    words[1].append(lineAfterComma)
                else:
                    elementIndex = words[1].index(lineAfterComma)
                    words[0][elementIndex] = str(
                        int(words[0][elementIndex]) + int(lineBeforeComma))  # later sort needs consistency

        fileName = open(file).name
        # write to file
        with open(fileName[0:len(fileName) - 4] + '.cleaned.csv', 'w+', encoding="utf8") as f:
            data = f.read()
            f.seek(0)
            for i in range(len(words[0])):
                f.write(words[0][i] + "," + words[1][i] + "\n")

print("Finished.")
